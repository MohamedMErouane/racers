<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>racers.fun - Waifu Racing Battles</title>
    <link rel="icon" type="image/png" href="images/ui/favicon.png">
    <link rel="stylesheet" href="styles.css">
    <!-- Add CSS for pulse animation -->
    <style>
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div id="animatedBg"></div>
    <div class="particles" id="particles"></div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Summoning Waifus...</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <h1>racers.fun</h1>
        </div>
        <div class="race-stats-nav">
            <div class="stat-item">
                <div class="stat-value" id="totalPot">0.00 SOL</div>
                <div class="stat-label">Total Pot</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalBets">0</div>
                <div class="stat-label">Total Bets</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="myBets">0 SOL</div>
                <div class="stat-label">My Bets</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="userBalance">100.0 SOL</div>
                <div class="stat-label">My Balance</div>
            </div>
        </div>
        <div class="wallet-controls">
            <button class="wallet-btn" id="walletBtn">Connect</button>
            <div class="wallet-actions" id="walletActions">
                <button class="deposit-btn" id="depositBtn">Deposit</button>
                <button class="withdraw-btn" id="withdrawBtn">Withdraw</button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Chat Panel -->
        <div class="chat-panel" id="chatPanel">
            <div class="chat-collapse-btn" id="chatCollapseBtn">
                <div class="notification-badge" id="notificationBadge">3</div>
                <span class="collapse-icon">‚óÄ</span>
            </div>
            <div class="chat-header">
                <div class="online-indicator">
                    <div class="online-dot"></div>
                    <span>Online: <span id="onlineCount">1337</span></span>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Connect wallet to chat..." disabled>
            </div>
            <div class="chat-rules" id="chatRules">
                <div class="solana-price">
                    <span class="price-label">‚óé</span>
                    <span class="price-value" id="solanaPrice">$0.00</span>
                </div>
                <div class="rules-icons">
                    <button class="icon-btn voice-btn" id="voiceBtn" title="Toggle Sound">üîä</button>
                    <button class="icon-btn faq-btn" id="faqBtn" title="FAQ">‚ùì</button>
                    <button class="icon-btn fair-btn" id="fairBtn" title="Provably Fair">‚öñÔ∏è</button>
                    <button class="icon-btn theme-btn" id="themeBtn" title="Toggle Light/Dark Mode">üåô</button>
                </div>
            </div>
            
        </div>

        <!-- Game Panel -->
        <div class="game-panel">
            <div class="race-info">
                <div class="race-header">
                    <h2>Race #<span id="raceNumber">1</span></h2>
                    <span>Next race in: <span id="nextRaceTime">60s</span></span>
                </div>
            </div>

            <div class="race-track-container">
                <!-- Update your HTML structure for better layout -->
                <div id="raceContainer" style="display: none; height: 80vh; width: 100%;">
                  <div class="race-display">
                    <!-- Positions Display -->
                    <div id="positionsDisplay"></div>
                    
                    <!-- Canvas Container -->
                    <div class="canvas-container">
                      <canvas id="raceCanvas"></canvas>
                    </div>
                    
                    <!-- Speed Display -->
                    <div id="speedDisplay"></div>
                  </div>
                </div>
            </div>

            <!-- Winner Modal -->
            <div class="winner-modal" id="winnerModal">
                <div class="winner-content">
                    <button class="close-winner-btn" id="closeWinnerBtn"></button>
                    <div class="winner-left">
                        <h2 class="victory-title">VICTORY!</h2>
                        <div class="winner-racer" id="winnerDisplay">
                            <img class="winner-racer-avatar" id="winnerAvatar" src="" alt="Winner">
                            <div class="winner-racer-name" id="winnerName">Character Name</div>
                        </div>
                        <div class="winner-buttons">
                            <button class="winner-btn">Download Image</button>
                            <button class="winner-btn">Share to Twitter</button>
                        </div>
                    </div>
                    <div class="winner-right">
                        <div class="race-statistics">
                            <h3>Race Statistics</h3>
                            <div class="pot-summary">
                                <h4>Pot Summary</h4>
                                <div class="pot-item">
                                    <span class="label">Total Pot:</span>
                                    <span class="value" id="modalTotalPot">0.00 SOL</span>
                                </div>
                                <div class="pot-item">
                                    <span class="label">Winner:</span>
                                    <span class="value" id="modalWinnerName">Character</span>
                                </div>
                            </div>
                            <div class="top-winners">
                                <h4>Top Winners</h4>
                                <div class="top-winner-item">
                                    <span>#1 ---</span>
                                    <span>---</span>
                                </div>
                                <div class="top-winner-item">
                                    <span>#2 ---</span>
                                    <span>---</span>
                                </div>
                                <div class="top-winner-item">
                                    <span>#3 ---</span>
                                    <span>---</span>
                                </div>
                            </div>
                            <div class="your-results">
                                <h4>Your Results</h4>
                                <div class="result-item">
                                    <span class="label">Total Bet:</span>
                                    <span class="value" id="modalYourBet">0.00 SOL ($0.00)</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Winnings:</span>
                                    <span class="value positive" id="modalYourWinnings">+0.00 SOL ($0.00)</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Net Result:</span>
                                    <span class="value positive" id="modalNetResult">+0.00 SOL ($0.00)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Betting Panel -->
        <div class="betting-panel">
            <div class="panel-header">
                <h2>Place Your Bets</h2>
            </div>
            
            <!-- Character Selection -->
            <div class="character-selection">
                <div class="selected-character" id="selectedCharacter">
                    <h3 id="selectedCharacterName">Select a Character</h3>
                </div>
                <div class="character-grid" id="characterGrid"></div>
            </div>
            
            <!-- Betting Options -->
            <div class="betting-options">
                <div class="quick-bets">
                    <h4>Quick Bets</h4>
                    <div class="quick-bet-buttons">
                        <button class="quick-bet-btn" data-amount="1">1 SOL</button>
                        <button class="quick-bet-btn" data-amount="3">3 SOL</button>
                        <button class="quick-bet-btn" data-amount="5">5 SOL</button>
                        <input type="number" id="customBetAmount" placeholder="_ SOL" min="0.1" step="0.1">
                    </div>
                    <button class="place-bet-btn" id="placeBetBtn">Place Bet - 0.0 SOL</button>
                </div>
            </div>
            
            <!-- Live Odds Display -->
            <div class="odds-display">
                <div class="odds-grid" id="oddsGrid">
                    <!-- Odds items will be populated here by JavaScript -->
                </div>
            </div>
            
            <!-- Live Betting Distribution -->
            <div class="betting-distribution">
                <h3>Live Betting Distribution</h3>
                
                <!-- Pie Chart Container -->
                <div class="pie-chart-container">
                    <div class="pie-chart-visual"></div>
                    <div class="pie-chart-center"></div>
                </div>
                
                <!-- Favorite Info -->
                <div class="favorite-info">
                    <span>Favorite: </span>
                    <span class="favorite-text">None (0%)</span>
                </div>
                
                <!-- Legend Container -->
                <div class="distribution-legend"></div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="deposit-modal" id="depositModal">
        <div class="deposit-content">
            <div class="deposit-header">
                <h2>Deposit</h2>
                <button class="close-btn" id="closeDepositModal">√ó</button>
            </div>
            
            <div class="deposit-body">
                <div class="token-section">
                    <label>Token</label>
                    <div class="token-selector">
                        <div class="token-option selected">
                            <div class="token-icon">‚óé</div>
                            <div class="token-info">
                                <span class="token-name">SOL</span>
                                <span class="token-label">Solana</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="balance-section">
                    <div class="balance-info">
                        <span class="balance-usd" id="walletBalanceUSD">‚âà $0.00 USD</span>
                        <span class="balance-amount" id="walletBalance">Balance: 0.000 SOL</span>
                    </div>
                </div>
                
                <div class="amount-section">
                    <label>Amount</label>
                    <div class="amount-input-container">
                        <input type="number" id="depositAmount" placeholder="0.00" step="0.01" min="0.01">
                        <span class="amount-usd">= $0.00</span>
                        <div class="token-unit">‚óé</div>
                    </div>
                </div>
                
                <div class="fee-info">
                    <span class="fee-text">Enjoy 0% fees on SOL deposits & withdrawals!</span>
                </div>
                
                <button class="deposit-action-btn" id="confirmDepositBtn">
                    DEPOSIT NOW
                </button>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="deposit-modal" id="withdrawModal">
        <div class="deposit-content">
            <div class="deposit-header">
                <h2>Withdraw</h2>
                <button class="close-btn" id="closeWithdrawModal">√ó</button>
            </div>
            
            <div class="deposit-body">
                <div class="token-section">
                    <label>Token</label>
                    <div class="token-selector">
                        <div class="token-option selected">
                            <div class="token-icon">‚óé</div>
                            <div class="token-info">
                                <span class="token-name">SOL</span>
                                <span class="token-label">Solana</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="balance-section">
                    <div class="balance-info">
                        <span class="balance-usd" id="platformBalanceUSD">‚âà $0.00 USD</span>
                        <span class="balance-amount" id="platformBalance">Platform Balance: 0.000 SOL</span>
                    </div>
                </div>
                
                <div class="amount-section">
                    <label>Amount</label>
                    <div class="amount-input-container">
                        <input type="number" id="withdrawAmount" placeholder="0.00" step="0.01" min="0.01">
                        <span class="amount-usd">= $0.00</span>
                        <div class="token-unit">‚óé</div>
                    </div>
                </div>
                
                <div class="fee-info">
                    <span class="fee-text">Enjoy 0% fees on SOL deposits & withdrawals!</span>
                </div>
                
                <button class="deposit-action-btn" id="confirmWithdrawBtn">
                    WITHDRAW NOW
                </button>
            </div>
        </div>
    </div>

    <!-- Countdown Display Element -->
    <div id="countdownDisplay" style="
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(0,0,0,0.8);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
    ">
    </div>

  <!-- Privy SDK Loader -->
  <script src="/js/privy-loader.js"></script>
  
    </div>

  <!-- FAQ Modal -->
  <div class="modal-overlay" id="faqModal">
    <div class="modal-content faq-modal">
      <div class="modal-header">
        <h2>Frequently Asked Questions</h2>
        <button class="modal-close" id="faqClose">&times;</button>
      </div>
      <div class="modal-body">
        <div class="faq-item">
          <h3 class="faq-question">1) How does a round work?</h3>
          <div class="faq-answer">
            <p>Pick 1 of 8 racers and place your bet before the countdown hits 0. All bets go into one pot. When the race ends, the smart contract pays out automatically: 86% of the pot goes to wallets that picked the winner (split pro-rata by their winning stake), 10% is returned as cashback to all losing wallets (also pro-rata by their losing stake), and 4% is the platform fee.</p>
            <p><strong>Quick example:</strong> Pot = 10 SOL. Winners' total stake = 3 SOL. You bet 0.5 SOL on the winner. Your payout = (0.5 / 3) √ó 8.6 = 1.433 SOL.<br>
            If you lost 0.20 SOL in that round and total losing stake was 7 SOL, your cashback = (0.20 / 7) √ó 1.0 = 0.0286 SOL.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <h3 class="faq-question">2) What's the house edge / fee?</h3>
          <div class="faq-answer">
            <p>We take a flat 4% of every round's total pot. That means 96% of the pot always returns to players (86% winners + 10% losers). Long-run expected return to players is 96% of total wagered volume.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <h3 class="faq-question">3) How is the game fair? Can I verify results?</h3>
          <div class="faq-answer">
            <p>All logic runs on-chain on Solana (SVM). Each round's outcome is produced by the contract's randomness routine and finalized on-chain; results and payouts are transparent in the transaction logs. We publish:</p>
            <ul>
              <li>the program address,</li>
              <li>the round ID + randomness inputs (e.g., seed/commit-reveal or VRF proof),</li>
              <li>and the settlement tx.</li>
            </ul>
            <p>With those, anyone can check: (a) the winning racer, (b) the pot size, and (c) every wallet's payout.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <h3 class="faq-question">4) Do I need a wallet? Which ones work?</h3>
          <div class="faq-answer">
            <p>Yes. Wallet connection is required to place bets and to chat. Any major Solana wallet works (e.g., Phantom, Solflare, Backpack). You sign a tx for each bet/withdrawal. Gas fees are tiny on Solana, but they still exist.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <h3 class="faq-question">5) How much can I bet? Are there limits?</h3>
          <div class="faq-answer">
            <p>You can bet any denomination up to your available balance (e.g., if you deposited 1 SOL, you can bet 0.03, 0.2, 0.77‚Äîyour call‚Äîup to 1 SOL). Bets lock when the countdown hits 0; if your transaction confirms after lock, it won't enter the pot and your funds stay in your balance.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <h3 class="faq-question">6) How does the 10% cashback for losers work?</h3>
          <div class="faq-answer">
            <p>After the winner is settled, the contract takes 10% of the pot and splits it pro-rata across all losing stakes from that round. Bigger losing stakes get a bigger share; tiny stakes get a tiny share. Cashback is credited instantly in the same settlement tx.</p>
          </div>
        </div>
        
        <div class="faq-item">
          <h3 class="faq-question">7) Deposits, withdrawals, and failed transactions</h3>
          <div class="faq-answer">
            <ul>
              <li><strong>Deposits:</strong> Send SOL to the game program via the site flow; your in-game balance updates after confirmation.</li>
              <li><strong>Withdrawals:</strong> You can withdraw your available balance any time; it's a standard Solana tx back to your wallet.</li>
              <li><strong>Failed/Pending bets:</strong> If a bet tx fails or confirms after the round lock, it's not included in the pot and no fee is taken. Your balance remains unchanged.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Provably Fair Modal -->
  <div class="modal-overlay" id="fairModal">
    <div class="modal-content fair-modal">
      <div class="modal-header">
        <h2>Provably Fair System</h2>
        <button class="modal-close" id="fairClose">&times;</button>
      </div>
      <div class="modal-body">
        <p class="intro">racers.fun uses a provably fair system. Winner selection is derived from a verifiable random value, and payouts are executed by program code on Solana. You can verify every round yourself.</p>
        
        <div class="fair-section">
          <h3>How it works</h3>
          <ol>
            <li>Before lock we publish either a VRF request or a seed hash.</li>
            <li>After the round, the randomness value is finalized on-chain.</li>
            <li>The program computes <code>winner_index</code> and settles payouts.</li>
            <li>You can verify the randomness and all transfers on an explorer.</li>
          </ol>
        </div>
        
        <div class="fair-section">
          <h3>Current Round</h3>
          <div class="round-info">
            <p><strong>Game Status:</strong> <span id="gameStatus" class="highlight-text">Active</span></p>
            <p><strong>Round ID:</strong> <span id="currentRoundId" class="success-text">1</span></p>
            <p><strong>Randomness:</strong> <span id="currentRandomness" class="warning-text">Hash pending...</span></p>
            <p class="note">Note: The seed is revealed after the game ends.</p>
          </div>
        </div>
        
        <div class="fair-section">
          <h3>Recent Rounds</h3>
          <div class="recent-rounds" id="recentRounds">
            <div class="round-item">
              <p><strong>Round ID:</strong> Previous round data will appear here</p>
            </div>
          </div>
        </div>
        
        <div class="fair-section">
          <h3>Payout Rules</h3>
          <div class="payout-rules">
            <p><strong>Winners:</strong> <span class="success-text">86%</span> of pot split pro-rata by winning stake</p>
            <p><strong>Losers:</strong> <span class="warning-text">10%</span> of pot split equally among losing wallets</p>
            <p><strong>Platform Fee:</strong> <span class="highlight-text">4%</span> of pot</p>
          </div>
        </div>
        
        <div class="fair-section">
          <h3>Legal & Responsible Play</h3>
          <ul>
            <li>You must be of legal age and permitted by your local laws.</li>
            <li>This is a game of chance. Do not wager more than you can afford to lose.</li>
            <li>Expected return to players is <span class="success-text">96%</span>. Long-run EV is negative.</li>
            <li>All transactions are final and executed on-chain.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Mock Privy Fallback -->
  <script src="/js/mock-privy.js"></script>
  
  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

  <!-- Configuration (load before modules) -->
  <script src="/js/config.js"></script>

  <!-- Main Application Script -->
  <script type="module" src="/js/main.js"></script>
</body>
</html>